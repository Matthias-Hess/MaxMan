name: PlatformIO Release

on:
  push:
    branches:
      - main        # Baut bei jedem Push (Test)
    tags:
      - 'v*'        # Feuert NUR bei Tags wie v1.0, v0.2.3 etc.

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # WICHTIG: Erlaubt dem Bot, Releases zu erstellen

    steps:
    # 1. Code auschecken
    # WICHTIG: fetch-depth: 0 holt alle Tags, damit das Python-Script die Version berechnen kann!
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # (Optional) Caching f체r PlatformIO Pakete - macht den Build viel schneller!
    - name: Cache Pio
      uses: actions/cache@v3
      with:
        path: |
          ~/.platformio
          .pio
        key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-

    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio

    # Dein angepasster Pfad
    - name: Run PlatformIO
      run: pio run -d software/src

    # Schritt 1: Artefakt f체r den manuellen Download (Debugging)
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: firmware-debug
        path: software/src/.pio/build/seeed_xiao_esp32c3/firmware.bin

    # ZWISCHENSCHRITT: Datei umbenennen f체r das Release
    # Wir h채ngen den Tag-Namen an den Dateinamen an (z.B. firmware_v1.0.0.bin)
    - name: Rename Firmware for Release
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cp software/src/.pio/build/seeed_xiao_esp32c3/firmware.bin firmware_${{ github.ref_name }}.bin

    # Schritt 2: Release erstellen (NUR wenn es ein Tag ist)
    - name: Release Firmware
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        # Wir laden jetzt die umbenannte Datei hoch
        files: firmware_${{ github.ref_name }}.bin
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}